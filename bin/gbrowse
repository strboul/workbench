#!/usr/bin/env bash
# shellcheck disable=SC2001

# Browse git remote repository on a browser (default is Firefox)
#
# Usage:
# gbrowse firefox <repo>
#

set -e

source "$HOME"/dotfiles/bin/__utils/utils.sh

DEFAULT_BROWSER="firefox"

get_git_remote_ssh_address() {
  local path="$1"
  git -C "$path" config --get remote.origin.url
}

get_browser_name() {
  # Update the browser names here if they change
  case "$1" in
    "chrome") echo "google-chrome-stable" ;;
    "firefox") echo "firefox" ;;
    *) utils__err_exit "unknown browser" ;;
  esac
}

open_browser() {
  local browser_name="$1"
  local url="$2"
  eval "$(printf "%s 2>/dev/null %s &" "$browser_name" "$url")"
}

str__remove_git_begin() {
  echo "$1" | sed "s/^git@//"
}

str__remove_git_end() {
  echo "$1" | sed "s/\.git$//"
}

str__replace_colon_slash() {
  echo "$1" | sed "s/\:/\//"
}

str__add_https_begin() {
  echo "$1" | sed "s/^/https:\/\//"
}

ssh_address_to_url() {
  local str
  str="$1"
  str="$(str__remove_git_begin "$str")"
  str="$(str__remove_git_end "$str")"
  str="$(str__replace_colon_slash "$str")"
  str="$(str__add_https_begin "$str")"
  echo "$str"
}

main() {
  local ssh_address
  local url
  local browser
  local path
  browser="$1"
  path="$2"

  select_path="$(utils__get_path "$path")"
  utils__git__check_repository "$select_path"

  ssh_address="$(get_git_remote_ssh_address "$select_path")"
  url="$(ssh_address_to_url "$ssh_address")"

  local browser_name

  if [ -n "$browser" ]; then
    browser_name="$(get_browser_name "$browser")"
  else
    browser_name="$DEFAULT_BROWSER"
  fi

  open_browser "$browser_name" "$url"
  utils__log__success "opened \"$url\""
}

main "$@"
